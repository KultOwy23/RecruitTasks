const sqlite3 = require('sqlite3').verbose();
const {Client} = require("@googlemaps/google-maps-services-js");
const client = new Client({});

const dailySql = "SELECT SUM(price) FROM journeys WHERE date = ? GROUP BY date";
const dateRangeSql = "SELECT * FROM journeys WHERE date > ? AND date < ?";
const deleteSql = "DELETE FROM journeys WHERE date = ?"
// open the database
let db = new sqlite3.Database('./db/journeys.db', sqlite3.OPEN_READWRITE, (err) => {
  if (err) {
    console.error(err.message);
  }
  console.log('Connected to the journeys database.');
});
db.run('CREATE TABLE IF NOT EXISTS journeys(date DATE, originAddress TEXT, destinationAddress TEXT, price REAL, distance REAL)');

saveJourney = (params, callback) => {
  const distPromise = calculateDistance(params.originAddress,params.destinationAddress);
  distPromise.then(res => {
    const distance = res.data.rows[0].elements[0].distance;
    if(distance) {
      db.serialize(() => {
        db.run(
          "INSERT INTO journeys(date,originAddress,destinationAddress,price,distance) VALUES(?,?,?,?,?)",
          [params.date,params.originAddress,params.destinationAddress,params.price, distance.value],
          (err) => {
            if(err) {
              callback(`SaveJourneyError: ${err}`);
            }
        });
      })
    }
    callback();
  }).catch(err => {
    callback(err,_);
  })
    
};

removeRecords = (date) => {
  db.serialize(() => {
    db.run(deleteSql, [date], (err) => {
      if(err) {
        throw new Error(`RemoveRecordsError: ${err}`);
      }
    });
  })
};

getDailyReport = (date) => {
  db.serialize(() => {
    db.all(dailySql, date, (err, rows) => {
      if(err) {
        throw new Error(`GetDailyReport: ${err}`);
      }
      let report = {}
      rows.forEach(row => {
          report['totalPrice'] = row.totalPrice;
          // report['totalDistance'] = row.distance
        }
      });
      return report;
    })
  })
}

calculateDistance = (originAddress, destinationAddress) => {
   return client.distancematrix({
      params: {
        origins: [originAddress],
        destinations: [destinationAddress],
        sensor: false,
        language: 'pl',
        key: process.env.GOOGLE_MAPS_API_KEY
      },
      timeout: 1000 // milliseconds
    })
}



module.exports = { db, saveJourney, removeRecords, getDailyReport, calculateDistance};